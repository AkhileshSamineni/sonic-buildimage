From 17d3ca1e46af41b16919a572156e373f9ef29b92 Mon Sep 17 00:00:00 2001
From: Akhilesh Samineni <akhilesh.samineni@broadcom.com>
Date: Sun, 15 Nov 2020 01:12:53 -0800
Subject: [PATCH] Link local scope was not set while binding socket with local
 address causing socket errors for bgp ipv6 link local neighbors.

---
 bgpd/bgp_network.c | 5 +++++
 bgpd/bgp_zebra.c   | 3 +++
 2 files changed, 8 insertions(+)

diff --git a/bgpd/bgp_network.c b/bgpd/bgp_network.c
index 1394c60b2..f5649abae 100644
--- a/bgpd/bgp_network.c
+++ b/bgpd/bgp_network.c
@@ -568,6 +568,11 @@ static int bgp_update_address(struct interface *ifp, const union sockunion *dst,
 		return 1;
 
 	prefix2sockunion(sel, addr);
+
+        if (IN6_IS_ADDR_LINKLOCAL(&addr->sin6.sin6_addr)) {
+                addr->sin6.sin6_scope_id = ifp->ifindex;
+        }
+
 	return 0;
 }
 
diff --git a/bgpd/bgp_zebra.c b/bgpd/bgp_zebra.c
index e561832e2..4880aaf6b 100644
--- a/bgpd/bgp_zebra.c
+++ b/bgpd/bgp_zebra.c
@@ -800,6 +800,9 @@ bool bgp_zebra_nexthop_set(union sockunion *local, union sockunion *remote,
 								? peer->conf_if
 								: peer->ifname,
 							peer->bgp->vrf_id);
+			else if (peer->update_if)
+				ifp = if_lookup_by_name(peer->update_if,
+						peer->bgp->vrf_id);
 		} else if (peer->update_if)
 			ifp = if_lookup_by_name(peer->update_if,
 						peer->bgp->vrf_id);
-- 
2.18.0

